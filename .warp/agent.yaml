name: Dosifi Tablet Agent
version: 1

about:
  description: |
    Agent for working on the Dosifi v5 Flutter project in Warp. Encodes your project rules,
    safe command patterns, and common workflows (build, run, analyze, fix, persistence) so
    tasks can be executed consistently. Uses PowerShell (pwsh) on Windows.
  repo_hint: .
  primary_language: dart

rules:
  # Your standing rules
  - always commit to the local git
  - ALways update the technical documentation
  # Terminal safety and conventions
  - never use pagers; for git add --no-pager or equivalent
  - avoid interactive/fullscreen commands
  - do not print secrets; use environment variables when needed
  - do not edit source code via shell; use structured diffs (apply_patch) for code changes
  - prefer absolute commands over cd chaining; if cd is required, keep it explicit
  - when reading or writing many files, batch operations to minimize churn

environment:
  os: windows
  shell: pwsh
  project_root: .
  android:
    sdk_hint: $env:ANDROID_HOME
  flutter:
    commands_are_available: true

paths:
  # Useful anchors (relative to project_root)
  lib: lib
  docs: docs
  scripts: scripts

variables:
  # Expected package name for adb tasks (edit if different)
  ANDROID_PACKAGE: com.dosifi.app
  # Default emulator serial (override as needed)
  ANDROID_EMULATOR: emulator-5554

commands:
  # Safe, idempotent commands (PowerShell)
  flutter: 'flutter'
  dart_format: 'dart format .'
  flutter_format: 'flutter format .'
  flutter_analyze: 'flutter analyze'
  flutter_clean: 'flutter clean'
  flutter_pub_get: 'flutter pub get'
  hive_build: 'flutter packages pub run build_runner build --delete-conflicting-outputs'
  run_debug: 'flutter run'
  run_release: 'flutter run --release'
  build_apk_debug: 'flutter build apk --debug'
  build_apk_release: 'flutter build apk --release'
  adb_uninstall: 'adb -s ${ANDROID_EMULATOR} uninstall ${ANDROID_PACKAGE}'
  adb_clear: 'adb -s ${ANDROID_EMULATOR} shell pm clear ${ANDROID_PACKAGE}'
  emulator_list: 'emulator -list-avds'
  # Example: 'emulator -avd <name> -wipe-data -no-snapshot' (supply <name> explicitly when running)

workflows:
  build:
    description: Clean, fetch deps, build adapters, analyze.
    steps:
      - ${flutter_clean}
      - ${flutter_pub_get}
      - ${hive_build}
      - ${flutter_analyze}
  run_debug:
    description: Launch the app on the current device/emulator in debug.
    steps:
      - ${run_debug}
  run_release:
    description: Launch the app in release mode.
    steps:
      - ${run_release}
  device_reset_app:
    description: Uninstall and clear app data on selected emulator.
    steps:
      - ${adb_uninstall}
      - ${adb_clear}
  fix_common:
    description: Apply common fixes (format and analyze) after code edits.
    steps:
      - ${dart_format}
      - ${flutter_analyze}
  build_release_apk:
    description: Build a release APK.
    steps:
      - ${flutter_clean}
      - ${flutter_pub_get}
      - ${hive_build}
      - ${build_apk_release}

git:
  # Always commit locally after successful changes
  auto_commit:
    enabled: true
    message_template: "Agent: {summary}"
  safety:
    use_no_pager: true

prompts:
  # High-level intents for the agent to follow
  - id: fix-build
    description: |
      Investigate current build errors and fix them with minimal, targeted diffs.
      Prefer reverting to a known-good UI skeleton if the widget tree is unbalanced.
    steps:
      - run: ${flutter_analyze}
      - run: ${dart_format}
      - plan: Identify the first error location and repair syntax/structure before continuing.
      - run: ${flutter_analyze}
      - commit: "Fix build: syntax/structure and analyzer warnings"
  - id: regenerate-hive
    description: Cleanly regenerate Hive adapters when type changes occur.
    steps:
      - run: ${flutter_clean}
      - run: ${hive_build}
      - run: ${flutter_analyze}
      - commit: "Hive: regenerate adapters"
  - id: reset-emulator-app
    description: Uninstall and clear app data on emulator.
    steps:
      - run: ${adb_uninstall}
      - run: ${adb_clear}
  - id: run-and-watch
    description: Run the app and watch logs for UI regressions.
    steps:
      - run: ${run_debug}

notes:
  - If a complex refactor causes cascading syntax errors, prefer reverting the affected widget subtree to a minimal,
    compilable version (Scaffold + one Card), then re-introduce elements incrementally.
  - For UI polish (field heights, alignment, dropdowns), rely on shared builders/widgets (e.g., an integer stepper) to
    avoid divergence between rows.
  - For any code edits, prefer structured diffs, keep changes small, and re-run analyze after each patch.
